# 轮换采样三个传感器的流程

## 概述
- 传感器：`MPU6050`（加速度/陀螺）、`HMC5883L`（地磁）、`MS561101BA`（气压/温度）。
- 接口：三者均通过 `I2C` 访问，显示通过 `OLED` 完成。
- 策略：采用状态机方式按固定周期轮换采样与显示，每次仅采样并展示一个传感器数据，降低总线占用与屏幕刷新压力。

## 初始化
- 调用 `ReadPeripherals_Init` 完成 `OLED` 与三个传感器初始化，并显示 `MPU6050` 的 `WHO_AM_I` 结果。
- 代码位置：`MyLib/ReadPeripherals.c:11`。

## 轮换采样状态机
- 核心接口：`ReadPeripherals_Process`，每次循环检查当前系统时间，与上次切换时间差是否达到采样周期；若达到则切换到下一个传感器并更新显示。
- 周期：`SAMPLE_PERIOD_MS = 500` 毫秒，三个传感器轮换顺序为 `MPU6050 → HMC5883L → MS5611`。
- 代码位置：`MyLib/ReadPeripherals.c:22`。

### 状态与变量
- 当前状态：`current_sensor`，类型 `SensorType`，初始化为 `SENSOR_MPU`。
- 上次切换毫秒计数：`last_switch_ms`。
- 采样周期：`SAMPLE_PERIOD_MS`。
- 代码位置：`MyLib/ReadPeripherals.c:5`、`MyLib/ReadPeripherals.c:7`、`MyLib/ReadPeripherals.c:8`、`MyLib/ReadPeripherals.c:9`。

### 传感器采样与显示
- `MPU6050`：读取加速度与陀螺的六轴数据，显示在两列。
  - 代码位置：`MyLib/ReadPeripherals.c:28`。
- `HMC5883L`：读取磁场 `X/Y/Z` 并显示。
  - 代码位置：`MyLib/ReadPeripherals.c:40`。
- `MS5611`：读取温度、气压并计算海拔后显示；若校准数据未准备好则显示错误信息。
  - 代码位置：`MyLib/ReadPeripherals.c:49`。

## MS5611 采样细节
- MS5611 的转换需要根据 `OSR` 等待固定时间，已在设备层封装：启动转换、延时、读取 `ADC`。
- 相关接口与实现：
  - 启动压力/温度转换：`MyLib/GY86.c:203`、`MyLib/GY86.c:213`。
  - 读取 `ADC`：`MyLib/GY86.c:223`。
  - 原始数据读取封装（含延时）：`MyLib/GY86.c:246`、`MyLib/GY86.c:253`。
  - 校准/补偿与海拔计算：`MyLib/GY86.c:266`。

## 主循环使用方法
- 在 `main` 中仅需初始化系统后调用：
  - `ReadPeripherals_Init`：`Src/main.c:48`。
  - 在 `while(1)` 中周期调用 `ReadPeripherals_Process`：`Src/main.c:51`。
- 其余时间保持短暂延时以避免忙等待，如 `HAL_Delay(5)`。

## 调整与扩展
- 更改采样周期：修改 `MyLib/ReadPeripherals.c:9` 的 `SAMPLE_PERIOD_MS`。
- 采样顺序调整：修改状态机 `switch` 分支顺序即可。
- 增加平均或滤波：在各分支采样后对原始值进行处理，再显示或输出。

## 代码位置总览
- 状态机与调度：`MyLib/ReadPeripherals.c`。
- 设备访问与补偿：`MyLib/GY86.c`、接口声明在 `MyLib/GY86.h`。
- 主循环入口：`Src/main.c`。
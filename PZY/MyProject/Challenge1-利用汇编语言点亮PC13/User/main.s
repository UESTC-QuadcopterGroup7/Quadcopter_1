;==============================================================================
; STM32F103C8 LED控制汇编程序
; 功能：PC13引脚的LED周期性闪烁（2秒间隔）
;==============================================================================

;==============================================================================
; 寄存器地址定义
;==============================================================================
RCC_BASE      EQU 0x40021000   ; RCC外设的基地址
RCC_APB2ENR   EQU (RCC_BASE + 0x18) ; APB2外设时钟使能寄存器地址
GPIOC_BASE    EQU 0x40011000   ; GPIOC外设的基地址
GPIOC_CRH     EQU (GPIOC_BASE + 0x04) ; 端口配置高寄存器地址
GPIOC_ODR     EQU (GPIOC_BASE + 0x0C) ; 端口输出数据寄存器
;==============================================================================
; 位状态定义
;==============================================================================
GPIOC_EN      EQU 0x00000010
LED_CONFIG  EQU 0x00300000
LED_ON        EQU 0x00000000   ; PC13输出低电平 (LED点亮)
LED_OFF       EQU 0x00002000   ; PC13输出高电平 (LED熄灭)
DELAY_MS      EQU 2000         ; 延时毫秒数，修改为2000ms（2秒）

;==============================================================================
; 代码段定义
;==============================================================================
                AREA    |.text|, CODE, READONLY
                THUMB                           ; 使用Thumb指令集
                REQUIRE8                        ; 要求8字节对齐
                PRESERVE8                       ; 保持8字节对齐

                EXPORT  __main                    ; 导出main函数
                ENTRY                           ; 程序入口点

;==============================================================================
; 主函数 - LED闪烁控制
;==============================================================================
__main
                ;--------------------------------------------------------------
                ; 步骤1: 开启GPIOC时钟
                ;--------------------------------------------------------------
                LDR     r0, =RCC_APB2ENR     ; 加载RCC_APB2ENR寄存器地址
                MOV     r1, #GPIOC_EN         ; 设置位4，使能GPIOC时钟
                STR     r1, [r0]             ; 写回寄存器

                ;--------------------------------------------------------------
                ; 步骤2: 配置PC13为推挽输出模式，50MHz
                ;--------------------------------------------------------------
                LDR     R0, =GPIOC_CRH       ; 加载GPIOC_CRH寄存器地址	
                MOV     R1, #LED_CONFIG        ; PC13配置为推挽输出，50MHz
                STR     R1, [R0]             ; 写回寄存器

;==============================================================================
; 主循环 - LED交替亮灭
;==============================================================================
main_loop       
                ; 点亮LED
                LDR     R0, =GPIOC_ODR
                MOV     R1, #LED_ON     
                STR     R1, [R0]                
                
                ; 延时2秒
                LDR     R0, =DELAY_MS
                BL      delay_ms                 ; 调用毫秒级延时函数

                ; 熄灭LED
                LDR     R0, =GPIOC_ODR
                MOV     R1, #LED_OFF     
                STR     R1, [R0]                
                
                ; 延时2秒
                LDR     R0, =DELAY_MS
                BL      delay_ms                 ; 调用毫秒级延时函数

                B       main_loop                ; 循环执行

;==============================================================================
; 毫秒级延时函数
; 输入: R0 = 延时毫秒数
; 假设系统时钟为8MHz
;==============================================================================
delay_ms
                PUSH    {R0, R1, LR}             ; 保存寄存器
delay_ms_loop1  MOV     R1, #0x2000             ; 内部循环计数(约1ms)
delay_ms_loop2  SUBS    R1, R1, #1              ; R1 = R1 - 1
                BNE     delay_ms_loop2          ; R1不为0则继续循环
                
                SUBS    R0, R0, #1              ; 总延时减1ms
                BNE     delay_ms_loop1          ; 未达到指定延时则继续
                
                POP     {R0, R1, PC}             ; 恢复寄存器并返回

                ALIGN                           ; 确保代码段对齐
                END


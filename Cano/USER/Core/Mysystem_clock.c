#include "Mysystem_clock.h"

void SystemClock_Config_HSI(void) {
    // 1. 复位RCC时钟配置到默认状态
    RCC_DeInit();

    // 2. 使能HSI
    RCC_HSICmd(ENABLE);
    
    // 等待HSI就绪
    while (RCC_GetFlagStatus(RCC_FLAG_HSIRDY) == RESET);

    // 3. 配置PLL
    // PLL配置: HSI(16MHz) /16 * 168 /2 = 84MHz
	//VCO输入频率 HSI/PLLM VCO输出频率HSI/PLLM*PLLN 
	//VCO输出频率 192<< <<432
	//系统时钟 VCO输出频率/PLLP USB时钟频率 VCO输出频率/PLLQ
    //系统时钟 84<< <<168
	RCC_PLLConfig(RCC_PLLSource_HSI, 8, 84, 2, 7);
    
    // 4. 使能PLL
    RCC_PLLCmd(ENABLE);
    
    // 等待PLL就绪
    while (RCC_GetFlagStatus(RCC_FLAG_PLLRDY) == RESET);

    // 5. 配置FLASH预取指缓存和等待状态
    FLASH_SetLatency(FLASH_Latency_2);           // 2个等待状态（对于84MHz在3.3V下）
    FLASH_PrefetchBufferCmd(ENABLE);             // 启用预取指缓存
    FLASH_InstructionCacheCmd(ENABLE);           // 启用指令缓存
    FLASH_DataCacheCmd(ENABLE);                  // 启用数据缓存

    // 6. 配置AHB、APB1和APB2分频器
    RCC_HCLKConfig(RCC_SYSCLK_Div1);             // AHB时钟 = SYSCLK = 84MHz
    RCC_PCLK1Config(RCC_HCLK_Div2);              // APB1时钟 = AHB/2 = 42MHz
    RCC_PCLK2Config(RCC_HCLK_Div1);              // APB2时钟 = AHB/1 = 84MHz

    // 7. 选择PLL作为系统时钟源
    RCC_SYSCLKConfig(RCC_SYSCLKSource_PLLCLK);
    
    // 等待系统时钟源切换完成
    while (RCC_GetSYSCLKSource() != 0x08);       // 0x08表示PLL作为系统时钟
}

void SystemClock_Config_BT(void){
	//启用HSE 因为HSI无法作为PLLI2S时钟源 
	RCC->CR|=RCC_CR_HSEON;
	while(!(RCC->CR&RCC_CR_HSERDY));
	//配置主PLL
	//HSE=8MHz PLLM=8MHz PLLN=336MHz PLLP=2MHz PLLQ=7MHz 
	//SYSCLK=168MHz PLLI2S_N=192 PLLI2S_R=5 PLLQ为7时为37.33MHz 为4时为48MHz
	RCC->PLLCFGR=(8<<0)|(336<<6)|(0<<16)|(1<<22)|(4<<24);
	//配置PLLI2S
	RCC->PLLI2SCFGR=(192<<6)|(5<<28);
	//启用PLL并等待就绪
	RCC->CR|=RCC_CR_PLLON;
	while(!(RCC->CR&RCC_CR_PLLRDY));
	
	//启用PLLI2S并等待就绪
	RCC->CR|=RCC_CR_PLLI2SON;
	while(!(RCC_CR_CSSON&RCC_CR_PLLI2SRDY));
	
	//设置Flash延迟
	FLASH->ACR=FLASH_ACR_ICEN|FLASH_ACR_DCEN|FLASH_ACR_LATENCY_5WS;
	
	//配置分频器
	RCC->CFGR|=RCC_CFGR_HPRE_DIV1; //AHB=168MHz
	RCC->CFGR|=RCC_CFGR_PPRE1_DIV4; //APB1=42MHz
	RCC->CFGR|=RCC_CFGR_PPRE2_DIV2; //APB2=84MHz
	
	//选择PLL作为系统时钟源
	RCC->CFGR&=~RCC_CFGR_SW;
	RCC->CFGR|=RCC_CFGR_SW_PLL;
	while((RCC->CFGR&RCC_CFGR_SWS)!=RCC_CFGR_SWS_PLL);
	
	//启用I2S时钟
	RCC->CR|=RCC_CR_PLLI2SON;
	while(!(RCC->CR&RCC_CR_PLLI2SRDY));
}

const float sin_table[SIN_TABLE_SIZE]= {
    0.0000, 0.0175, 0.0349, 0.0523, 0.0698, 0.0872, 0.1045, 0.1219, 0.1392, 0.1564,
    0.1736, 0.1908, 0.2079, 0.2250, 0.2419, 0.2588, 0.2756, 0.2924, 0.3090, 0.3256,
    0.3420, 0.3584, 0.3746, 0.3907, 0.4067, 0.4226, 0.4384, 0.4540, 0.4695, 0.4848,
    0.5000, 0.5150, 0.5299, 0.5446, 0.5592, 0.5736, 0.5878, 0.6018, 0.6157, 0.6293,
    0.6428, 0.6561, 0.6691, 0.6820, 0.6947, 0.7071, 0.7193, 0.7314, 0.7431, 0.7547,
    0.7660, 0.7771, 0.7880, 0.7986, 0.8090, 0.8192, 0.8290, 0.8387, 0.8480, 0.8572,
    0.8660, 0.8746, 0.8829, 0.8910, 0.8988, 0.9063, 0.9135, 0.9205, 0.9272, 0.9336,
    0.9397, 0.9455, 0.9511, 0.9563, 0.9613, 0.9659, 0.9703, 0.9744, 0.9781, 0.9816,
    0.9848, 0.9877, 0.9903, 0.9925, 0.9945, 0.9962, 0.9976, 0.9986, 0.9994, 0.9998,
    1.0000, 0.9998, 0.9994, 0.9986, 0.9976, 0.9962, 0.9945, 0.9925, 0.9903, 0.9877,
    0.9848, 0.9816, 0.9781, 0.9744, 0.9703, 0.9659, 0.9613, 0.9563, 0.9511, 0.9455,
    0.9397, 0.9336, 0.9272, 0.9205, 0.9135, 0.9063, 0.8988, 0.8910, 0.8829, 0.8746,
    0.8660, 0.8572, 0.8480, 0.8387, 0.8290, 0.8192, 0.8090, 0.7986, 0.7880, 0.7771,
    0.7660, 0.7547, 0.7431, 0.7314, 0.7193, 0.7071, 0.6947, 0.6820, 0.6691, 0.6561,
    0.6428, 0.6293, 0.6157, 0.6018, 0.5878, 0.5736, 0.5592, 0.5446, 0.5299, 0.5150,
    0.5000, 0.4848, 0.4695, 0.4540, 0.4384, 0.4226, 0.4067, 0.3907, 0.3746, 0.3584,
    0.3420, 0.3256, 0.3090, 0.2924, 0.2756, 0.2588, 0.2419, 0.2250, 0.2079, 0.1908,
    0.1736, 0.1564, 0.1392, 0.1219, 0.1045, 0.0872, 0.0698, 0.0523, 0.0349, 0.0175,
    0.0000, -0.0175, -0.0349, -0.0523, -0.0698, -0.0872, -0.1045, -0.1219, -0.1392, -0.1564,
    -0.1736, -0.1908, -0.2079, -0.2250, -0.2419, -0.2588, -0.2756, -0.2924, -0.3090, -0.3256,
    -0.3420, -0.3584, -0.3746, -0.3907, -0.4067, -0.4226, -0.4384, -0.4540, -0.4695, -0.4848,
    -0.5000, -0.5150, -0.5299, -0.5446, -0.5592, -0.5736, -0.5878, -0.6018, -0.6157, -0.6293,
    -0.6428, -0.6561, -0.6691, -0.6820, -0.6947, -0.7071, -0.7193, -0.7314, -0.7431, -0.7547,
    -0.7660, -0.7771, -0.7880, -0.7986, -0.8090, -0.8192, -0.8290, -0.8387, -0.8480, -0.8572,
    -0.8660, -0.8746, -0.8829, -0.8910, -0.8988, -0.9063, -0.9135, -0.9205, -0.9272, -0.9336,
    -0.9397, -0.9455, -0.9511, -0.9563, -0.9613, -0.9659, -0.9703, -0.9744, -0.9781, -0.9816,
    -0.9848, -0.9877, -0.9903, -0.9925, -0.9945, -0.9962, -0.9976, -0.9986, -0.9994, -0.9998,
    -1.0000, -0.9998, -0.9994, -0.9986, -0.9976, -0.9962, -0.9945, -0.9925, -0.9903, -0.9877,
    -0.9848, -0.9816, -0.9781, -0.9744, -0.9703, -0.9659, -0.9613, -0.9563, -0.9511, -0.9455,
    -0.9397, -0.9336, -0.9272, -0.9205, -0.9135, -0.9063, -0.8988, -0.8910, -0.8829, -0.8746,
    -0.8660, -0.8572, -0.8480, -0.8387, -0.8290, -0.8192, -0.8090, -0.7986, -0.7880, -0.7771,
    -0.7660, -0.7547, -0.7431, -0.7314, -0.7193, -0.7071, -0.6947, -0.6820, -0.6691, -0.6561,
    -0.6428, -0.6293, -0.6157, -0.6018, -0.5878, -0.5736, -0.5592, -0.5446, -0.5299, -0.5150,
    -0.5000, -0.4848, -0.4695, -0.4540, -0.4384, -0.4226, -0.4067, -0.3907, -0.3746, -0.3584,
    -0.3420, -0.3256, -0.3090, -0.2924, -0.2756, -0.2588, -0.2419, -0.2250, -0.2079, -0.1908,
    -0.1736, -0.1564, -0.1392, -0.1219, -0.1045, -0.0872, -0.0698, -0.0523, -0.0349, -0.0175,
    0.0000
};
